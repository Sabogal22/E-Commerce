---

---

<div class="flex items-center space-x-8" id="user-actions">
  <!-- Moneda -->
  <div class="flex items-center space-x-2 bg-gray-100 px-4 py-2 rounded-full">
    <span class="font-bold text-gray-700">COP $</span>
    <span class="text-gray-600">Pesos Colombianos</span>
  </div>

  <!-- Sección de autenticación -->
  <div id="auth-section"></div>
</div>

<script>
  // Funciones de utilidad con tipos explícitos
  const AuthUtils = {
    // Verificar si hay sesión activa
    isAuthenticated: () => {
      return (
        typeof window !== "undefined" &&
        localStorage.getItem("nk_token") !== null
      );
    },

    // Obtener datos del usuario
    getCurrentUser: () => {
      if (typeof window !== "undefined") {
        const userData = localStorage.getItem("nk_user");
        return userData ? JSON.parse(userData) : null;
      }
      return null;
    },

    // Cerrar sesión
    logout: () => {
      if (typeof window !== "undefined") {
        localStorage.removeItem("nk_user");
        localStorage.removeItem("nk_token");
        window.location.href = "/";
      }
    },

    // Contar items en carrito
    getCartCount: () => {
      if (typeof window !== "undefined") {
        const cartData = localStorage.getItem("nk_cart");
        const items = cartData ? JSON.parse(cartData) : [];
        return items.reduce((count: number, item: any) => count + (item.quantity || 0), 0);
      }
      return 0;
    },

    // Calcular total del carrito
    getCartTotal: () => {
      if (typeof window !== "undefined") {
        const cartData = localStorage.getItem("nk_cart");
        const items = cartData ? JSON.parse(cartData) : [];
        return items.reduce(
          (total: number, item: any) => total + (item.price || 0) * (item.quantity || 0),
          0
        );
      }
      return 0;
    },
  };

  // Función para renderizar la sección de autenticación
  function renderAuthSection() {
    const authSection = document.getElementById("auth-section");
    if (!authSection) return;

    const isLoggedIn = AuthUtils.isAuthenticated();
    const user = AuthUtils.getCurrentUser();
    const cartCount = AuthUtils.getCartCount();
    const cartTotal = AuthUtils.getCartTotal();

    if (isLoggedIn && user) {
      // USUARIO LOGEADO
      const userInitial = user.name ? user.name.charAt(0).toUpperCase() : "U";
      const userName = user.name || "Usuario";
      const userEmail = user.email || user.username || "";

      authSection.innerHTML = `
        <div class="flex items-center space-x-6">
          <!-- Carrito -->
          <a href="/carrito" class="relative group">
            <div class="flex items-center space-x-3 bg-gray-50 hover:bg-gray-100 px-4 py-3 rounded-xl transition-all">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                </path>
              </svg>
              <div>
                <div class="font-medium text-gray-700">Mi Carrito</div>
                <div class="text-sm text-gray-500">
                  ${cartCount} producto${cartCount !== 1 ? "s" : ""} - $${cartTotal.toLocaleString("es-CO")}
                </div>
              </div>
            </div>
            ${
              cartCount > 0
                ? `
              <span class="absolute -top-2 -right-2 bg-red-600 text-white text-sm font-bold rounded-full w-6 h-6 flex items-center justify-center">
                ${cartCount}
              </span>
            `
                : ""
            }
          </a>
          
          <!-- Dropdown de usuario -->
          <div class="relative group">
            <button class="flex items-center space-x-3 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl transition-all">
              <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                <span class="text-sm font-bold">${userInitial}</span>
              </div>
              <span class="font-medium">${userName}</span>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>
            
            <!-- Menú desplegable -->
            <div class="absolute right-0 top-full mt-2 w-56 bg-white shadow-2xl rounded-xl py-3 hidden group-hover:block z-50 border border-gray-100">
              <div class="px-4 py-2 border-b">
                <p class="text-sm text-gray-600">Conectado como</p>
                <p class="font-medium truncate">${userEmail}</p>
              </div>
              
              <div class="py-2">
                <a href="/usuario/perfil" class="flex items-center space-x-3 px-4 py-2 hover:bg-red-50 text-gray-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span>Mi Perfil</span>
                </a>
                
                <a href="/usuario/pedidos" class="flex items-center space-x-3 px-4 py-2 hover:bg-red-50 text-gray-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                  </svg>
                  <span>Mis Pedidos</span>
                </a>
                
                <a href="/usuario/favoritos" class="flex items-center space-x-3 px-4 py-2 hover:bg-red-50 text-gray-700">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                  </svg>
                  <span>Favoritos</span>
                </a>
              </div>
              
              <div class="border-t pt-2">
                <button 
                  id="logout-btn"
                  class="flex items-center space-x-3 w-full px-4 py-2 hover:bg-red-50 text-red-600 font-medium"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                  </svg>
                  <span>Cerrar Sesión</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;

      // Configurar evento de logout
      setTimeout(() => {
        const logoutBtn = document.getElementById("logout-btn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", () => {
            if (confirm("¿Estás seguro de que quieres cerrar sesión?")) {
              AuthUtils.logout();
            }
          });
        }
      }, 100);
    } else {
      // USUARIO NO LOGEADO
      authSection.innerHTML = `
        <div class="flex items-center space-x-4">
          <!-- Carrito deshabilitado -->
          <div class="relative opacity-50 cursor-not-allowed" title="Inicia sesión para ver tu carrito">
            <div class="flex items-center space-x-3 bg-gray-100 px-4 py-3 rounded-xl">
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                </path>
              </svg>
              <div>
                <div class="font-medium text-gray-400">Mi Carrito</div>
                <div class="text-sm text-gray-400">Inicia sesión</div>
              </div>
            </div>
          </div>
          
          <!-- Botón de Login/Registro -->
          <div class="flex items-center space-x-3">
            <a 
              href="/login" 
              class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-xl font-medium transition-all"
            >
              Iniciar Sesión
            </a>
            <a 
              href="/register" 
              class="border-2 border-red-600 text-red-600 hover:bg-red-50 px-6 py-3 rounded-xl font-medium transition-all"
            >
              Registrarse
            </a>
          </div>
        </div>
      `;

      // Configurar redirección del carrito deshabilitado
      setTimeout(() => {
        const disabledCart = authSection.querySelector(".cursor-not-allowed");
        if (disabledCart) {
          disabledCart.addEventListener("click", (e) => {
            e.preventDefault();
            window.location.href = "/login?redirect=/carrito";
          });
        }
      }, 100);
    }
  }

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", () => {
    renderAuthSection();

    // Escuchar cambios en el almacenamiento
    window.addEventListener("storage", (e) => {
      if (e.key === "nk_token" || e.key === "nk_user") {
        renderAuthSection();
      }
    });
  });
</script>

<style>
  /* Estilos para el dropdown de usuario */
  .group:hover .group-hover\\:block {
    display: block !important;
  }

  /* Tooltip para carrito deshabilitado */
  [title] {
    position: relative;
  }

  [title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 5px;
  }
</style>
